<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Облачный редактор с логином</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
        }

        textarea {
            width: 100%;
            height: 300px;
            padding: 10px;
            font-size: 16px;
        }

        input {
            padding: 8px;
            margin: 5px 0;
            width: 250px;
        }

        button {
            padding: 8px 15px;
            margin: 5px 0;
        }
    </style>
</head>

<body>
    <h1>Мой облачный текст</h1>

    <div id="authSection">
        <h2>Вход / Регистрация</h2>
        <input type="email" id="email" placeholder="Email"><br>
        <input type="password" id="password" placeholder="Пароль"><br>
        <button id="registerBtn">Регистрация</button>
        <button id="loginBtn">Вход</button>
    </div>

    <div id="editorSection" style="display:none;">
        <p id="status"></p>
        <button id="logoutBtn">Выйти</button><br>
        <textarea id="editor" placeholder="Начните писать..."></textarea>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // Твой конфиг
        const firebaseConfig = {
            apiKey: "AIzaSyBC8yqtzenwdGa0g6f1vRt2OTwVAWj44n0",
            authDomain: "kroll-7e9fe.firebaseapp.com",
            projectId: "kroll-7e9fe",
            storageBucket: "kroll-7e9fe.appspot.com",
            messagingSenderId: "760854621728",
            appId: "1:760854621728:web:9837af479a6da599e71645",
            measurementId: "G-4RPNT5Y75R"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const registerBtn = document.getElementById('registerBtn');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const status = document.getElementById('status');
        const editor = document.getElementById('editor');

        const authSection = document.getElementById('authSection');
        const editorSection = document.getElementById('editorSection');

        let userDocRef = null;
        let unsubscribeSnapshot = null;

        // Регистрация
        registerBtn.onclick = () => {
            auth.createUserWithEmailAndPassword(emailInput.value, passwordInput.value)
                .catch(err => alert(err.message));
        };

        // Вход
        loginBtn.onclick = () => {
            auth.signInWithEmailAndPassword(emailInput.value, passwordInput.value)
                .catch(err => alert(err.message));
        };

        // Выход
        logoutBtn.onclick = () => auth.signOut();

        // Реакция на смену пользователя
        auth.onAuthStateChanged(user => {
            if (user) {
                authSection.style.display = 'none';
                editorSection.style.display = 'block';
                status.textContent = `Вы вошли как ${user.email}`;

                userDocRef = db.collection('notes').doc(user.uid);

                // Отписка от прошлой подписки
                if (unsubscribeSnapshot) unsubscribeSnapshot();

                // Слушаем изменения в реальном времени
                unsubscribeSnapshot = userDocRef.onSnapshot(doc => {
                    if (doc.exists && editor.value !== doc.data().text) {
                        editor.value = doc.data().text || "";
                    }
                });

                // Мгновенное сохранение при изменении
                editor.oninput = () => {
                    userDocRef.set({ text: editor.value })
                        .then(() => console.log("Текст сохранён"))
                        .catch(err => console.error("Ошибка сохранения:", err));
                };

            } else {
                // Очистка при выходе
                authSection.style.display = 'block';
                editorSection.style.display = 'none';
                editor.value = "";
                userDocRef = null;
                if (unsubscribeSnapshot) unsubscribeSnapshot();
                unsubscribeSnapshot = null;
            }
        });
    </script>
</body>

</html>